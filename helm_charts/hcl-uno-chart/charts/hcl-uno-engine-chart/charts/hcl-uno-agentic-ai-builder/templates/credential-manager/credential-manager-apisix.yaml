{{ $fullname := include "agenticbuilder.fullname" . }}
{{- $root := . -}}
{{- $credentialManagerName := printf "%s-%s" $fullname .Values.credentialManager.name | trunc 80 }}

apiVersion: apisix.apache.org/v2
kind: ApisixUpstream
metadata:
  name: {{ $credentialManagerName }}
  annotations:
    kubernetes.io/ingress.class: {{ .Values.common.apisix.ingressClassName }}
spec:
  loadbalancer:
    type: roundrobin
  scheme: https
  ingressClassName: {{ .Values.common.apisix.ingressClassName }}
---
apiVersion: apisix.apache.org/v2
kind: ApisixRoute
metadata:
  name: "{{ $credentialManagerName }}-route"
  annotations:
    kubernetes.io/ingress.class: {{ .Values.common.apisix.ingressClassName }}
spec:
  ingressClassName: {{ .Values.common.apisix.ingressClassName }}
  http:
  - name: "main-route"
    match:
      paths:
      - "/{{ $credentialManagerName }}/*"
      - "/credential-manager/*"
    backends:
    - serviceName: {{ $credentialManagerName }}
      servicePort: {{ .Values.credentialManager.port }}
    plugins:
    - name : serverless-pre-function
      enable: true
      config:
        phase: "rewrite"
        functions:
          - |
            return function(_,ctx)
              ctx.var.rewrited_uri = ctx.var.uri
              ctx.var.rewrited_uri = string.gsub(ctx.var.rewrited_uri, "/{{ include "agenticbuilder.replace.dash.percentdash" $credentialManagerName }}/", "")
              ctx.var.rewrited_uri = string.gsub(ctx.var.rewrited_uri, "/credential%-manager/", "")
            end
    - name: proxy-rewrite
      enable: true
      config:
        uri: "/$rewrited_uri"
